# サーバ開発
ソースコードとかの軽い説明を記すが，構成は私の卒論とかmemoの手書きメモを読んで欲しいです．

# 資料群
- memo : 開発で考えたメモ等(手書きや参考リンク集)
- sourcecode : 開発してたサーバのソースコード
    - inspect-system : プロトタイプとして実験とかしてたとこ
        - mappage : 履歴表示用サーバ
        - reverse-proxy : リバースプロキシ
        - store-srv : MySQLを使わずにjsonでデータ記録しようとした名残．
        - webpage : WebPushの確認用に作ったサーバ
    - temp-system : LTEモジュールとの通信ように急遽作成したPOST応答を確認するだけのサーバ
        - notification-server : 通知確認用(実際は動かなかった気がする)
        - respose-server : LTE通信モジュールからのPOSTメソッドを受け取ったことを確認するだけのサーバ．response-serverのタイポ．
    - verify-system : 本番の開発をしてたとこ
        - analizer-node : 解析(山口担当部分)を定期的に起動するためのコンテナ作成用フォルダ(中身は無い)
        - database-api : MySQLのコンテナとのアクセスを仲介するようのコンテナ作成用フォルダ(中身は無い)
        - notification-app : WebPushサーバ作成用フォルダ(inspect-systemとかから移植してないから，中身は無い)
        - reverse-proxy : クラウド上のサーバ(オンプレミスでも可)へのアクセスをnotification-appやvisualizer-appといったサーバに振り分けるリバースプロキシコンテナ作成用フォルダ
        - visualizer-app : 行動履歴表示サーバコンテナ作成用フォルダ(移植がまだだったかな?)


# 現状
基本的にdockerコンテナでサーバシステムを作り，docker composeでそのコンテナごとを連携させる．
今の所，以下に記す感じでできている
- docker composeでdocker networkを作成して形は作れる状態
- reverse proxy は一応できてnginxの複数サーバへの分配は確認済み
- nginxをnode.jsへ変更してアクセス確認は一応したがなんか不安定だった(reverse proxyの設定が悪い可能性がある)
    - reverse-proxyのURLがドメインとファイルディレクトリの間にあるスラッシュが消えるのが不可解だった(https://github.com"/"gisuperuのダブルクォーテーションで囲った部分が消えた)
- temp-system/notification-serverでhttpsでの通信ができるnode.jsのserverファイルを置いてる(動作確認済み)
- temp-system/notification-serverでWebPushがスマホ(Safari Google Chrome)，タブレット(Safari)，PC(Safari，Google Chrome)で受け取れることの確認をした
- temp-system.notification-serverではWebPushを登録するサーバのみ作成して，そこで取得した各端末のsubscribeデータを使って別の実行ファイルで通知イベントを発生させてる(send.js)
- 履歴表示はinspect-system/mappageにあるpractice.jsやregister.jsにそこそこの概形ができているはず

今後としては，
- reverse-proxyとnode.jsサーバにしたときのURLが綺麗になる
- 履歴表示アプリ(visualizer-app)の移植
- 通知サーバ(notification-app)の移植
- データベースへの保存(MySQLコンテナとSQL APIの作成をhttps://qiita.com/niisan1ban/items/f70eb0ed891568f71f9bを参考に)
- POSTでくるデータがデータベースに保存されるかの確認
- データベースの更新に合わせて解析プログラム(山口担当)を起動させるロジックを考える(私が考えていたのはPOSTが来た時に通知シグナルを起こしてデータが一つくるごとに解析を回す or 十秒ごとに解析プログラムを起動して更新があれば動くように解析プログラムをいい感じに例外処理を書いて常時起動)
- 農業従事者及び畑の登録ページを作成
これらができたらその他との連携は十分すぎるぐらいできる．(もはや完成)

加えて，私が使ってたさくらのVPSは私の個人契約しているやつを研究転用してただけなのでサーバを用意する必要があります(各自のPCでやるか研究室のPCもしくは各クラウドサーバを使うか先生と相談して決めて下さい)
進捗に合わせてその他システムと連携した実験を行い適宜UIや仕様を決定して下さい．
(現状の構成が良くなさそうだったら変えてもらって大丈夫です．むしろ変えたほうがいいかもしれない)
開発は初めから完成形を作るようなフローを書きましたが，グレードダウンしたシステム(データベースをjsonのようなNoSQLに変更や一部イベント処理を手動で繋ぐなど)を一旦作ることで構成の粗を見つけたり思考の整理ができるのでおすすめです．(プロトタイピング設計)

また，dockerやNode.jsは奈良高専の図書館に本があるので漁るといいです．(研究室に本があったかは忘れた)



# 選定思想
## クラウド
AWS，Azure，GCP，さくらのVPSとか比較したけど高専プロコンの協賛であるさくらインターネットが1年間無料で使えるVPSを公開してるからそれを使った．
今後を考えるとその他を考えないといけないが今回は学習コストの考えてAWSやAzure，GCPはあきらめた(VPSは一から設定するから4年の本間先生の実験と大体同じ感覚)
調べた肌感としては超巨大化するならAWS(値段が高いけど)かAzure．
GCPは機械学習とかなら軍配が上がりそう．
小規模ならオンプレミスが無難感

## システム構成
### 基盤
コンテナ技術としてdockerを使っているが仮想環境の一種みたいな感じなので開発用環境(自前PC)とデプロイ環境(VPS)のOS差をほとんど消せるのがつよみ(Docker以外のコンテナ技術を使ってもいいけど資料が少ないからパスした)
将来的にはKubernetesを使ってサーバを冗長化したいという思想を出したかったから(論文に書く的な意味としても)Kubernetesで使えるDockerを使った

### 内部ネットワーク
Docker networkを使って仮想コンテナ間を内部に押し込んでリバースプロキシのみインターネットとのアクセスをするようにすることで余計なセキュリティを考える手間を省いている(データベースのAPIも同じ思想)
余計なアクセスができると開発とか検証の自由度は高いけど，その分悪さをする自由度も上がるので必要な処理以外はそもそもリクエスト受け付けない設計の方が無難に安全になりやすい

### 通知
通知機構を実装する上で各自の端末で見れるようにしたくて，専用端末を作るとコストが上がるので避けたかった．
そう考えたら，スマホやパソコンで見れる通知になるが，基本的に起動しないできた時だけ瞬時に解る必要があり，Push通知に目をつけた．
ただ，Push通知を実現するとOSごとにアプリケーションを作る必要があり特に日本での普及率が異常に多いiphoneのアプリ開発をするのが学習コスト的に大変だったので避けたかった．
加えて，スマホアプリを作ると定期的なシステムアップデートする量が対応させたOSの数だけ増えて大変なので困る．
そこでWebPush(ブラウザが代わりにPush通知をしてくれる機構)を使って実現しようとした．
WebPushはブラウザをPWA(ブラウザをアプリ化する)にする設定が余分に必要なだけで基本的にWebページ作成と同じになる．
WebPushが思ったより色々なブラウザに対応している感じだったから使った．(ただ，うざいWebページとかで使われていたりするからイメージとか考えて若干悩んだ)

### 履歴表示
ここではWebページ上で地図を表示することがマストだった．(通知からアクセスできることもあるけどWebページにした時点でリンクを通知に載せればいいのでその問題は初めからクリア)
地図表示をする上で最もメジャーなのがGoogle MapのAPIを使うことだが，なんか最近有料になったっぽいので無料で使えるLeaflet.jsを使った．
Leaflet.jsは地図(画像)を使って色々レイヤーで重ねたりできるライブラリ．
使う地図としてはOpenStreatMapや日本の国土地理院の地図とかが営利目的以外は問題ない(読んだ時は)感じだったので使った．(地図を使うときは規約をちゃんと読もう)
社会実装のテーマなので営利目的にするときに規約とかの制限で使えない可能性もあるのでGoogle MapのAPIも色々調べておいた方が無難．

履歴表示はLeaflet.jsで地図の緯度経度を使って位置指定することで線やピンを立てられる．
センサデータはセンサの番号しか得られないので，地図の中心の絶対座標と地図の縮尺，地図の中心からの各センサの相対位置と番号を使って計算して表示したらいい感じ．

### リバースプロキシ
NginxやApache，Node.jsで作るなど色々方法があるけど，
簡単そう+手間が少なそう+割とメジャーっぽいという理由でNginxを使って実装した．
大体インターネットでコピペしながらやってたから工夫はしてない(多分)
Docker compose内でやる事例は思ったより見つからなかった気がするから調べるのは結構大変だった思い出．

### データベース
今のところ実装できてないから雑なことしか書けないけど一応．
データベースの種類としてはSQLとかNoSQLとか色々あるけど正直研究ならなんでもいいかなというイメージだった．
なのでプロトタイピングでは一旦json(NoSQL)で作って最終的にMySQLに起こしたらいいかなって思ってたけど実装が結構変わりそうだったから初めからMySQLを使った設計に変えた．
MySQL以外にもMongoDBとかSQLiteとか色々あるけど何かのサイトを参考にしてMySQLにした気がする(リンク忘れましたごめんなさい)
データベースのAPIはSQLインジェクションとかデータ改竄をPOSTで送られる(センサデータに偽装して送るような攻撃)をされると困るからアクセス方法をしっかり縛るために門番的に設置した．
まあ，攻撃を考えたセキュリティは後々実装すればいいので構成だけAPIを作っておけば変更が少なくていいかなってイメージ(説得力とか構成理由とかそうゆう観点)